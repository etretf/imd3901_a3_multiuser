<html>
    <head>
        <title>WebXR Multi-User Experience</title>
        <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <!-- Scripts -->
    </head>
    <body>
        <a-scene id="scene" device-orientation-permission-ui physics="debug: true;">
            <a-entity id="player"
            player
            camera
            wasd-controls
            look-controls
            position="0 5 0"
            >
                <!-- Raycaster -->
                <a-entity id="player-raycaster" cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive"></a-entity>
            </a-entity>

            <!-- Test zone -->
             <a-box
                id="test-box"
                look-controls
                plane-rotation
                static-body
                position="0 2 -7"
                width="3.5"
                depth="3.5"
                height="0.5"
             ></a-box>
             <a-sphere
                id="test-ball"
                class="interactive"
                dynamic-body
                position="0 2.5 -7"
                material="color: blue;"
                radius="0.3"
             ></a-sphere>


            <a-plane
                id="xval"
                material="color: black"
                position="-2 5 -8"
                text="value: x: ;wrapCount: 15;"
            ></a-plane>
            <a-plane
                id="yval"
                material="color: black"
                position="0 5 -8"
                text="value: y: ;wrapCount: 15;"
            ></a-plane>
            <a-plane
                id="zval"
                material="color: black"
                position="2 5 -8"
                text="value: z: ;wrapCount: 15;"
            ></a-plane>


            <a-entity environment="preset: forest;"></a-entity>
        </a-scene>
        <script>
            const socket = io();

            socket.on('connect', () => {
                console.log('Hello ' + socket.id);

                document.querySelector('#test-ball').addEventListener('click', function () {
                    socket.emit('blue');
                })
            })

            socket.on('change', (data) => {
                console.log('clicked')
                const el = document.querySelector('#test-ball')
                const elPos = el.getAttribute('position')
                el.body.applyImpulse(
                    new CANNON.Vec3(0, 10, 0),
                    new CANNON.Vec3().copy(new CANNON.Vec3(elPos.x, elPos.y, elPos.z))
                )
            })

            socket.on('get_player_info', () => {
                console.log('getting players data');
                const playerPos = document.querySelector('#player').getAttribute('position');
                socket.emit('set_player_info', {id: socket.id, pos: playerPos});
            })

            socket.on('update_co', (data) => {
                console.log(data);

                let dataKeys = Object.keys(data);

                if (dataKeys.length >= 1) {
                    dataKeys.forEach((key) => {
                        if (key === socket.id) {
                            return
                        }

                        let playerId = `player-${key}`;
                        let el = document.querySelector(`#${playerId}`);
                        if (el === null) {
                            let newPlayer = document.createElement('a-entity');
                            newPlayer.setAttribute('geometry', {primitive: 'box'});
                            newPlayer.setAttribute('material', {color: 'red'});
                            newPlayer.setAttribute('position', data[key]);
                            newPlayer.setAttribute('id', playerId);
                            document.querySelector('#scene').appendChild(newPlayer);
                            console.log('undefined, newly created char');
                        } else {
                            debugger
                            el.setAttribute('geometry', {primitive: 'box'});
                            el.setAttribute('material', {color: 'red'});
                            el.setAttribute('position', data[key]);
                        }
                        console.log('end of loop');
                    })
                }
            })
         </script>
    </body>
</html>
<html>
    <head>
        <title>WebXR Multi-User Experience</title>
        <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script> -->
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://unpkg.com/tone"></script>
        <!-- Scripts -->
        <!-- <script src="js/constants.js"></script> -->
        <script src="js/piano-note.js"></script>
        <script src="js/piano-spawn.js"></script>
        <script src="js/black-key.js"></script>
        <script src="js/game-manager.js"></script>
        <script src="js/play-note.js"></script>
        <script src="js/teleport-pad.js"></script>

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">

        <!-- Stylesheet links -->
        <link rel="stylesheet" href="css/user-gesture.css">

        <script>
            AFRAME.registerComponent('start-experience', {
                init: function () {
                    document.querySelector('#user-gesture-button').style.display='block';
                }
            });

            const startCompetitive = async function () {
                await Tone.start();
                document.querySelector('#user-gesture-overlay').style.display= 'none';
            };
        </script>
    </head>
    <body>
        <body>
            <!-- by having a 2D "user gesture" we can allow sounds to play and the like. We will make it an overlay so nothing can be clicked before the user gesture ... -->
            <!-- https://developers.google.com/web/updates/2017/09/autoplay-policy-changes (fun memes on webpage;) -->
            <div id="user-gesture-overlay">
              <div class="center">
                <!-- <button class="user-gesture-button-blue" style="display: block;">
                    <a href="collaborative.html">Collaborate on music</a>
                </button> -->
                <button id="user-gesture-button" onclick="startCompetitive()" class="user-gesture-button" style="display: block;">
                    Enter experience
                </button>
              </div>
            </div>
            <a-scene start-experience>
                <a-assets>
                    <img id="gameScreenImg" src="assets/images/gameScreen.png" crossorigin="anonymous">
                    <img id="buttonGreen" src="assets/images/buttonGreen.png" crossorigin="anonymous">
                    <img id="buttonMagenta" src="assets/images/buttonMagenta.png" crossorigin="anonymous">
                    <img id="buttonOrange" src="assets/images/buttonOrange.png" crossorigin="anonymous">
                </a-assets>
                <!-- Game manager -->
                    <a-entity id="game-manager" game-manager></a-entity>
                <!-- Player -->
                <a-entity id="player"
                    player
                    camera
                    wasd-controls
                    look-controls
                    position="0 1.6 0"
                >
                    <!-- Raycaster -->
                    <a-entity id="player-raycaster" cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive"></a-entity>
                </a-entity>
    
                <!-- Lights -->
                    
                <a-entity light="intensity: 0.5;" position="0 8.35603 6.40487" rotation="33.30374479977423 179.9998479605043 179.9998479605043"></a-entity>
                
                <!-- Teleport pads -->

                <a-cylinder teleport-pad></a-cylinder>
                <a-cylinder teleport-pad position="0 0 -1"></a-cylinder>
                <a-cylinder teleport-pad position="0 0 -2"></a-cylinder>

                <!-- Game screen -->

                <a-image id="game-screen" src="#gameScreenImg" width="6" height="4" position="0 2 -8">
                    <a-image id="start-button" class="interactive" src="#buttonGreen" position="0 -1.2 1.5" width="1" height="0.5" text="value: Start; wrapCount: 8; align:center;"></a-image>
                    <a-image id="play-sound-button" visible="false" src="#buttonOrange" position="0 -1.2 1.5" width="1" height="0.5" text="value: PLAY SOUND; wrapCount: 12; align:center;"></a-image>
                    <a-image id="restart-button" visible="false" src="#buttonMagenta" position="0 -1.2 1.5" width="1" height="0.5" text="value: RESTART; wrapCount: 12; align:center;"></a-image>
                    <a-image id="player-count" visible="false" src="#buttonGreen" position="0 -1.2 1.5" width="1" height="0.5"></a-image>
                </a-image>

                <!-- Sound source for game -->
                <a-entity id="sound-player" play-note></a-entity>
                
                <!-- Piano -->
                <a-box
                    id="piano-spawn"
                    piano-spawn
                    position="0 0.13 -4.5"
                    material="color: black;"
                    position="0 0.25 0"
                    width="7.5"
                    height="0.26"
                    depth="1.8"
                >
                    <a-box
                        id="piano-backpiece"
                        position="0 0.3 -0.75"
                        material="color: black;"
                        position="0 0.25 0"
                        width="7.5"
                        height="0.4"
                        depth="0.3"
                    ></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: C#3" position="-3.22258 0.3 -0.17921" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: D#3" position="-2.71826 0.3 -0.17921" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: F#3" position="-1.7479 0.3 -0.17921" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: G#3" position="-1.2569 0.3 -0.17921" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: A#3" position="-0.76768 0.3 -0.17921" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: C#4" position="0.20623 0.3 -0.17921" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: D#4" position="0.70041 0.3 -0.179" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: F#4" position="1.68533 0.3 -0.17921" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: G#4" position="2.18132 0.3 -0.17921" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                    <a-box class="interactive piano-note" black-key piano-note="note: A#4" position="2.67089 0.3 -0.17921" material="color: black" depth="1" height="0.3" width="0.30"></a-box>
                </a-box>
                <a-entity environment="preset: starry;"></a-entity>
            </a-scene>
        <script>
            const socket = io();

            // Competitive game logic

            socket.on('connect', () => {
                document.querySelector('#game-manager').setAttribute('game-manager', 'currentPlayerId', socket.id);
            });

            socket.on('update_game_state', (data) => {
                const gameManagerEl = document.querySelector('#game-manager');
                gameManagerEl.setAttribute('game-manager', 'roundState', data.roundState);
                gameManagerEl.setAttribute('game-manager', 'gameState', data.state);
            });

            socket.on('get_player_data', (data) => {
                const numReadyPlayers = data.players.filter(player => player.ready === true).length;
                const totalNumPlayers = data.players.length;
                const minTotalNumPlayers = totalNumPlayers === 1 ? 2 : totalNumPlayers;
                const playerCountText = `${numReadyPlayers}/${minTotalNumPlayers}`
                document.querySelector('#player-count').setAttribute('text', text=`value: ${playerCountText}; wrapCount: 12; align:center;`);
            });

            socket.on('play_note', (data) => {
                const soundPlayer = document.querySelector('#sound-player');
                soundPlayer.setAttribute('play-note', {note: data.note});
                soundPlayer.emit('play_note', data.note);
            });

            socket.on('round_result', (data) => {
                const gameManagerEl = document.querySelector('#game-manager')
                gameManagerEl.setAttribute('game-manager', 'roundState', data.roundState);
                gameManagerEl.setAttribute('game-manager', 'roundWinner', data.id);
            });

            socket.on('game_over', (data) => {
                const gameManagerEl = document.querySelector('#game-manager')
                gameManagerEl.setAttribute('game-manager', 'roundState', data.roundState);
                gameManagerEl.setAttribute('game-manager', 'roundResults', data.roundResults);
                gameManagerEl.setAttribute('game-manager', 'gameState', data.state);
            });
            
            // Competitive game logic end

        </script>
    </body>
</html>
<html>
    <head>
        <title>WebXR Multi-User Experience</title>
        <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script> -->
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://unpkg.com/tone"></script>
        <!-- Scripts -->
        <script src="js/play-note.js"></script>
        <script src="js/piano-note.js"></script>
        <script type="module" src="js/piano-spawn.js"></script>
        <script src="js/black-key.js"></script>
        <script src="js/game-manager.js"></script>

        <!-- Stylesheet links -->
        <link rel="stylesheet" href="/css/user-gesture.css">

        <!-- <script>
            AFRAME.registerComponent('start-experience', {
              init: function () {
                //we can't play sound on some browsers until we have some user interaction
                //this means we should only start playing ambient music after this button is clicked
                console.log('scene loaded');
                document.querySelector('#user-gesture-button').style.display='block';
              }
            });
            
            //function called from user-gesture click
            const startExperience = async function() {
              //hide user-gesture overlay
              document.querySelector('#user-gesture-overlay').style.display='none';
              await Tone.start();
              console.log('audio is ready');
            }
        </script> -->
    </head>
    <body>
        <body>
            <!-- by having a 2D "user gesture" we can allow sounds to play and the like. We will make it an overlay so nothing can be clicked before the user gesture ... -->
            <!-- https://developers.google.com/web/updates/2017/09/autoplay-policy-changes (fun memes on webpage;) -->
            <!-- <div id="user-gesture-overlay">
              <div class="center">
                <button id="user-gesture-button" onclick="startExperience();">enter experience</button>
              </div>
            </div> -->
        <a-scene start-experience>
            <a-assets>
                <img id="gameScreenImg" src="assets/images/gameScreen.png" alt="">
            </a-assets>
            <!-- Game manager -->
             <a-entity game-manager></a-entity>
            <!-- Player -->
            <a-entity id="player"
            player
            camera
            wasd-controls
            look-controls
            position="0 1.6 0"
            >
                <!-- Raycaster -->
                <a-entity id="player-raycaster" cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive"></a-entity>
            </a-entity>

            <!-- Game screen -->

            <a-plane position="0 2.43287 -10" geometry="height: 2.36; width: 3.37" src="#gameScreenImg">
                <a-cylinder radius="1" position="0 -2 0"></a-cylinder>
            </a-plane>

            <a-image id="imageGame" src="#gameScreenImg"></a-image>
            
            <a-entity environment="preset: starry;"></a-entity>
        </a-scene>
        <script>
            const socket = io();

            socket.on('connect', () => {
                console.log('Hello ' + socket.id);

                // document.querySelector('#test-ball').addEventListener('click', function () {
                //     socket.emit('blue');
                // })
            })

            socket.on('change', (data) => {
                console.log('clicked')
                const el = document.querySelector('#test-ball')
                const elPos = el.getAttribute('position')
                el.body.applyImpulse(
                    new CANNON.Vec3(0, 10, 0),
                    new CANNON.Vec3().copy(new CANNON.Vec3(elPos.x, elPos.y, elPos.z))
                )
            })

            socket.on('get_player_info', () => {
                const playerPos = document.querySelector('#player').getAttribute('position');
                socket.emit('set_player_info', {id: socket.id, pos: playerPos});
            })

            socket.on('update_co', (data) => {
                let dataKeys = Object.keys(data);

                if (dataKeys.length >= 1) {
                    dataKeys.forEach((key) => {
                        if (key === socket.id) {
                            return
                        }

                        let playerId = `player-${key}`;
                        let el = document.querySelector(`#${playerId}`);
                        if (el === null) {
                            let newPlayer = document.createElement('a-entity');
                            newPlayer.setAttribute('geometry', {primitive: 'box'});
                            newPlayer.setAttribute('material', {color: 'red'});
                            newPlayer.setAttribute('position', data[key]);
                            newPlayer.setAttribute('id', playerId);
                            document.querySelector('a-scene').appendChild(newPlayer);
                        } else {
                            el.setAttribute('geometry', {primitive: 'box'});
                            el.setAttribute('material', {color: 'red'});
                            el.setAttribute('position', data[key]);
                        }
                    })
                }
            })

            socket.on('player_disconnect', (id) => {
                const playerElToDelete = document.querySelector('#player-' + id);
                playerElToDelete.parentNode.removeChild(playerElToDelete);
            })
         </script>
    </body>
</html>